<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aplikasi Pembuat Soal Ujian</title>
  <base href="/" />
  <link rel="stylesheet" href="/styles.css" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
</head>
<body>
  <div class="container">
    <header class="header">
      <h1><i class="fas fa-file-alt"></i> Aplikasi Pembuat Soal Ujian</h1>
      <p>Buat, impor, dan ekspor soal ujian dengan mudah</p>
    </header>

    <div id="message-container" aria-live="polite" role="alert">
      <% if (errors && errors.length) { %>
      <div class="alert alert-danger" role="alert">
        <i class="fas fa-exclamation-circle" aria-hidden="true"></i>
        <% errors.forEach((err) => { %>
        <p><%= err %></p>
        <% }); %>
      </div>
      <% } %>

      <% if (success && success.length) { %>
      <div class="alert alert-success" role="alert">
        <i class="fas fa-check-circle" aria-hidden="true"></i>
        <% success.forEach((msg) => { %>
        <p><%= msg %></p>
        <% }); %>
      </div>
      <% } %>
    </div>

    <section class="card" aria-labelledby="import-header">
      <header class="card-header" id="import-header">
        <i class="fas fa-file-import"></i> Impor Soal dari Word
      </header>
      <div class="card-body">
        <form
          action="/import"
          method="post"
          enctype="multipart/form-data"
          id="importForm"
          aria-describedby="import-desc"
        >
          <div class="form-group">
            <label for="wordFile"
              ><i class="fas fa-file-word"></i> Pilih File Dokumen (.docx)</label
            >
            <input
              type="file"
              class="form-control"
              name="wordFile"
              id="wordFile"
              accept=".docx"
              required
            />
          </div>
          <button type="submit" class="btn btn-success">
            <i class="fas fa-upload"></i> Import dari Word
          </button>
        </form>
      </div>
    </section>

    <section class="card" aria-labelledby="add-question-header">
      <header class="card-header" id="add-question-header">
        <i class="fas fa-plus-circle"></i> Tambah Soal Baru
      </header>
      <div class="card-body">
        <form id="questionForm" aria-describedby="question-form-desc" novalidate>
          <div class="form-group">
            <label for="questionType"
              ><i class="fas fa-question-circle"></i> Tipe Soal</label
            >
            <select
              class="form-control"
              name="type"
              id="questionType"
              aria-required="true"
            >
              <option value="mc">Pilihan Ganda</option>
              <option value="short">Isian Singkat</option>
              <option value="essay">Esai</option>
            </select>
          </div>

          <div class="form-type" id="mcForm" role="group" aria-label="Pilihan Ganda">
            <div class="form-group">
              <label for="mcQuestion"
                ><i class="fas fa-question"></i> Pertanyaan</label
              >
              <textarea
                class="form-control"
                name="question"
                id="mcQuestion"
                placeholder="Masukkan pertanyaan..."
                required
                aria-required="true"
              ></textarea>
            </div>

            <label><i class="fas fa-list"></i> Opsi Jawaban</label>
            <div class="options-grid">
              <div class="form-group">
                <input
                  type="text"
                  class="form-control"
                  name="opt1"
                  placeholder="Opsi A"
                  required
                  aria-required="true"
                />
              </div>
              <div class="form-group">
                <input
                  type="text"
                  class="form-control"
                  name="opt2"
                  placeholder="Opsi B"
                  required
                  aria-required="true"
                />
              </div>
              <div class="form-group">
                <input
                  type="text"
                  class="form-control"
                  name="opt3"
                  placeholder="Opsi C"
                  required
                  aria-required="true"
                />
              </div>
              <div class="form-group">
                <input
                  type="text"
                  class="form-control"
                  name="opt4"
                  placeholder="Opsi D"
                  required
                  aria-required="true"
                />
              </div>
            </div>

            <div class="form-group">
              <label for="mcAnswer"
                ><i class="fas fa-check-circle"></i> Jawaban Benar</label
              >
              <input
                type="text"
                class="form-control"
                name="answer"
                placeholder="Masukkan huruf jawaban benar (A/B/C/D)"
                required
                aria-required="true"
                pattern="[ABCDabcd]"
                title="Masukkan huruf jawaban benar (A, B, C, atau D)"
              />
            </div>
          </div>

          <div
            class="form-type"
            id="shortForm"
            style="display: none;"
            role="group"
            aria-label="Isian Singkat"
          >
            <div class="form-group">
              <label for="shortQuestion"
                ><i class="fas fa-question"></i> Pertanyaan</label
              >
              <textarea
                class="form-control"
                name="question"
                id="shortQuestion"
                placeholder="Masukkan pertanyaan..."
                required
                aria-required="true"
              ></textarea>
            </div>
            <div class="form-group">
              <label for="shortAnswer"
                ><i class="fas fa-check-circle"></i> Jawaban</label
              >
              <input
                type="text"
                class="form-control"
                name="answer"
                placeholder="Masukkan jawaban singkat"
                required
                aria-required="true"
              />
            </div>
          </div>

          <div
            class="form-type"
            id="essayForm"
            style="display: none;"
            role="group"
            aria-label="Esai"
          >
            <div class="form-group">
              <label for="essayQuestion"
                ><i class="fas fa-question"></i> Pertanyaan</label
              >
              <textarea
                class="form-control"
                name="question"
                id="essayQuestion"
                placeholder="Masukkan pertanyaan..."
                required
                aria-required="true"
              ></textarea>
            </div>
            <div class="form-group">
              <label for="essayAnswer"
                ><i class="fas fa-check-circle"></i> Jawaban</label
              >
              <textarea
                class="form-control"
                name="answer"
                id="essayAnswer"
                placeholder="Masukkan jawaban esai"
                required
                aria-required="true"
              ></textarea>
            </div>
          </div>

          <button type="submit" class="btn btn-block" id="submitBtn" aria-live="polite">
            <i class="fas fa-plus"></i> Tambah Soal
          </button>
        </form>
        <button
          id="resetBtn"
          class="btn btn-danger"
          style="margin-top: 10px;"
          aria-live="polite"
          aria-label="Reset Soal"
        >
          <i class="fas fa-undo"></i> Reset Soal
        </button>
      </div>
    </section>

    <section class="preview-section" aria-labelledby="preview-header">
      <header class="preview-header" id="preview-header">
        <h2><i class="fas fa-eye"></i> Preview Soal</h2>
        <a href="/export" class="btn btn-success" aria-label="Ekspor ke Word">
          <i class="fas fa-file-export"></i> Ekspor ke Word
        </a>
      </header>

      <div id="preview-container">
        <section class="card" aria-labelledby="mc-preview-header">
          <header class="card-header" id="mc-preview-header">
            <i class="fas fa-list-ol"></i> Soal Pilihan Ganda
            <span class="count-badge"><%= exam.mc.length %>/50</span>
          </header>
          <div class="card-body">
            <% if (exam.mc.length === 0) { %>
            <p class="text-center">Belum ada soal pilihan ganda</p>
            <% } else { %>
            <div class="question-list">
              <% exam.mc.forEach((q, i) => { %>
              <article class="question-card" aria-label="Soal Pilihan Ganda nomor <%= i+1 %>">
                <span class="question-type">Pilihan Ganda</span>
                <h3><%= i + 1 %>. <%= q.question %></h3>
                <p><strong>A.</strong> <%= q.options[0] %></p>
                <p><strong>B.</strong> <%= q.options[1] %></p>
                <p><strong>C.</strong> <%= q.options[2] %></p>
                <p><strong>D.</strong> <%= q.options[3] %></p>
                <p><strong>Jawaban:</strong> <%= q.answer %></p>
              </article>
              <% }); %>
            </div>
            <% } %>
          </div>
        </section>

        <section class="card" aria-labelledby="short-preview-header">
          <header class="card-header" id="short-preview-header">
            <i class="fas fa-pen"></i> Soal Isian Singkat
            <span class="count-badge"><%= exam.shortAnswer.length %>/10</span>
          </header>
          <div class="card-body">
            <% if (exam.shortAnswer.length === 0) { %>
            <p class="text-center">Belum ada soal isian singkat</p>
            <% } else { %>
            <div class="question-list">
              <% exam.shortAnswer.forEach((q, i) => { %>
              <article class="question-card" aria-label="Soal Isian Singkat nomor <%= i+1 %>">
                <span class="question-type">Isian Singkat</span>
                <h3><%= i + 1 %>. <%= q.question %></h3>
                <p><strong>Jawaban:</strong> <%= q.answer %></p>
              </article>
              <% }); %>
            </div>
            <% } %>
          </div>
        </section>

        <section class="card" aria-labelledby="essay-preview-header">
          <header class="card-header" id="essay-preview-header">
            <i class="fas fa-align-left"></i> Soal Esai
            <span class="count-badge"><%= exam.essay.length %>/10</span>
          </header>
          <div class="card-body">
            <% if (exam.essay.length === 0) { %>
            <p class="text-center">Belum ada soal esai</p>
            <% } else { %>
            <div class="question-list">
              <% exam.essay.forEach((q, i) => { %>
              <article class="question-card" aria-label="Soal Esai nomor <%= i+1 %>">
                <span class="question-type">Esai</span>
                <h3><%= i + 1 %>. <%= q.question %></h3>
                <p><strong>Jawaban:</strong> <%= q.answer %></p>
              </article>
              <% }); %>
            </div>
            <% } %>
          </div>
        </section>
      </div>
    </section>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const questionType = document.getElementById('questionType');
      const mcForm = document.getElementById('mcForm');
      const shortForm = document.getElementById('shortForm');
      const essayForm = document.getElementById('essayForm');
      const questionForm = document.getElementById('questionForm');
      const submitBtn = document.getElementById('submitBtn');
      const messageContainer = document.getElementById('message-container');
      const previewContainer = document.getElementById('preview-container');
      const resetBtn = document.getElementById('resetBtn');

      // Fungsi untuk menampilkan form yang sesuai
      function showActiveForm() {
        mcForm.style.display = 'none';
        shortForm.style.display = 'none';
        essayForm.style.display = 'none';

        if (questionType.value === 'mc') {
          mcForm.style.display = 'block';
        } else if (questionType.value === 'short') {
          shortForm.style.display = 'block';
        } else if (questionType.value === 'essay') {
          essayForm.style.display = 'block';
        }
      }

      // Event listener untuk perubahan tipe soal
      questionType.addEventListener('change', showActiveForm);

      // Inisialisasi tampilan form
      showActiveForm();

      // Tangani pengiriman form dengan AJAX
      questionForm.addEventListener('submit', async function (e) {
        e.preventDefault();

        // Validasi form HTML5
        if (!questionForm.checkValidity()) {
          questionForm.reportValidity();
          return;
        }

        // Tampilkan loading
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menambahkan...';
        submitBtn.disabled = true;

        try {
          // Kumpulkan data form
          const formData = new FormData(questionForm);

          // Kirim data ke server
          const response = await fetch('/add', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(formData),
          });

          const result = await response.json();

          if (result.success) {
            // Tampilkan pesan sukses
            messageContainer.innerHTML = `
              <div class="alert alert-success" role="alert">
                <i class="fas fa-check-circle" aria-hidden="true"></i>
                <p>${result.message}</p>
              </div>
            `;

            // Reset form
            questionForm.reset();

            // Perbarui preview
            previewContainer.innerHTML = `
              <section class="card" aria-labelledby="mc-preview-header">
                <header class="card-header" id="mc-preview-header">
                  <i class="fas fa-list-ol"></i> Soal Pilihan Ganda
                  <span class="count-badge">${result.exam.mc.length}/50</span>
                </header>
                <div class="card-body">
                  ${
                    result.exam.mc.length === 0
                      ? '<p class="text-center">Belum ada soal pilihan ganda</p>'
                      : `<div class="question-list">
                    ${result.exam.mc
                      .map(
                        (q, i) => `
                      <article class="question-card" aria-label="Soal Pilihan Ganda nomor ${
                        i + 1
                      }">
                        <span class="question-type">Pilihan Ganda</span>
                        <h3>${i + 1}. ${q.question}</h3>
                        <p><strong>A.</strong> ${q.options[0]}</p>
                        <p><strong>B.</strong> ${q.options[1]}</p>
                        <p><strong>C.</strong> ${q.options[2]}</p>
                        <p><strong>D.</strong> ${q.options[3]}</p>
                        <p><strong>Jawaban:</strong> ${q.answer}</p>
                      </article>
                    `
                      )
                      .join('')}
                  </div>`
                  }
                </div>
              </section>

              <section class="card" aria-labelledby="short-preview-header">
                <header class="card-header" id="short-preview-header">
                  <i class="fas fa-pen"></i> Soal Isian Singkat
                  <span class="count-badge">${result.exam.shortAnswer.length}/10</span>
                </header>
                <div class="card-body">
                  ${
                    result.exam.shortAnswer.length === 0
                      ? '<p class="text-center">Belum ada soal isian singkat</p>'
                      : `<div class="question-list">
                    ${result.exam.shortAnswer
                      .map(
                        (q, i) => `
                      <article class="question-card" aria-label="Soal Isian Singkat nomor ${
                        i + 1
                      }">
                        <span class="question-type">Isian Singkat</span>
                        <h3>${i + 1}. ${q.question}</h3>
                        <p><strong>Jawaban:</strong> ${q.answer}</p>
                      </article>
                    `
                      )
                      .join('')}
                  </div>`
                  }
                </div>
              </section>

              <section class="card" aria-labelledby="essay-preview-header">
                <header class="card-header" id="essay-preview-header">
                  <i class="fas fa-align-left"></i> Soal Esai
                  <span class="count-badge">${result.exam.essay.length}/10</span>
                </header>
                <div class="card-body">
                  ${
                    result.exam.essay.length === 0
                      ? '<p class="text-center">Belum ada soal esai</p>'
                      : `<div class="question-list">
                    ${result.exam.essay
                      .map(
                        (q, i) => `
                      <article class="question-card" aria-label="Soal Esai nomor ${
                        i + 1
                      }">
                        <span class="question-type">Esai</span>
                        <h3>${i + 1}. ${q.question}</h3>
                        <p><strong>Jawaban:</strong> ${q.answer}</p>
                      </article>
                    `
                      )
                      .join('')}
                  </div>`
                  }
                </div>
              </section>
            `;
          } else {
            // Tampilkan pesan error
            messageContainer.innerHTML = `
              <div class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-circle" aria-hidden="true"></i>
                <p>${result.message}</p>
              </div>
            `;
          }
        } catch (error) {
          console.error('Error:', error);
          messageContainer.innerHTML = `
            <div class="alert alert-danger" role="alert">
              <i class="fas fa-exclamation-circle" aria-hidden="true"></i>
              <p>Terjadi kesalahan saat menambahkan soal</p>
            </div>
          `;
        } finally {
          // Kembalikan tombol ke keadaan semula
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;

          // Sembunyikan pesan setelah 5 detik
          setTimeout(() => {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach((alert) => {
              alert.style.opacity = '0';
              setTimeout(() => alert.remove(), 300);
            });
          }, 5000);
        }
      });

      // Tangani klik tombol reset soal
      resetBtn.addEventListener('click', async function () {
        if (
          !confirm(
            'Apakah Anda yakin ingin mereset semua soal? Data yang sudah ditambahkan akan hilang.'
          )
        ) {
          return;
        }
        resetBtn.disabled = true;
        resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mereset...';
        try {
          const response = await fetch('/reset', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
          });
          const result = await response.json();
          if (result.success) {
            messageContainer.innerHTML = `
              <div class="alert alert-success" role="alert">
                <i class="fas fa-check-circle" aria-hidden="true"></i>
                <p>${result.message}</p>
              </div>
            `;
            // Perbarui preview soal
            previewContainer.innerHTML = `
              <section class="card" aria-labelledby="mc-preview-header">
                <header class="card-header" id="mc-preview-header">
                  <i class="fas fa-list-ol"></i> Soal Pilihan Ganda
                  <span class="count-badge">0/50</span>
                </header>
                <div class="card-body">
                  <p class="text-center">Belum ada soal pilihan ganda</p>
                </div>
              </section>

              <section class="card" aria-labelledby="short-preview-header">
                <header class="card-header" id="short-preview-header">
                  <i class="fas fa-pen"></i> Soal Isian Singkat
                  <span class="count-badge">0/10</span>
                </header>
                <div class="card-body">
                  <p class="text-center">Belum ada soal isian singkat</p>
                </div>
              </section>

              <section class="card" aria-labelledby="essay-preview-header">
                <header class="card-header" id="essay-preview-header">
                  <i class="fas fa-align-left"></i> Soal Esai
                  <span class="count-badge">0/10</span>
                </header>
                <div class="card-body">
                  <p class="text-center">Belum ada soal esai</p>
                </div>
              </section>
            `;
          } else {
            messageContainer.innerHTML = `
              <div class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-circle" aria-hidden="true"></i>
                <p>${result.message}</p>
              </div>
            `;
          }
        } catch (error) {
          console.error('Error:', error);
          messageContainer.innerHTML = `
            <div class="alert alert-danger" role="alert">
              <i class="fas fa-exclamation-circle" aria-hidden="true"></i>
              <p>Terjadi kesalahan saat mereset soal</p>
            </div>
          `;
        } finally {
          resetBtn.disabled = false;
          resetBtn.innerHTML = '<i class="fas fa-undo"></i> Reset Soal';

          // Sembunyikan pesan setelah 5 detik
          setTimeout(() => {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach((alert) => {
              alert.style.opacity = '0';
              setTimeout(() => alert.remove(), 300);
            });
          }, 5000);
        }
      });
    });
  </script>
</body>
</html>
